<!-- a4908444-4f74-474b-81f7-51f48abb106c 37288b62-b161-4944-aecf-f5aea0188cd2 -->
# Test Coverage Expansion Plan (Reconciled)

## 1) Coverage Baseline

- Run jest and playwright with coverage; publish reports
- Focus on files with <60% lines or <50% branches

## 2) Unit Tests: Fill Real Gaps (new)

- src/utils/token-format.js: pairs/lists/strings/booleans formatting
- features/selection/selection-utils.js: rect selection, toggle, multi-drag deltas (snapshot variant)
- features/selection/clipboard-utils.js: collectSelection, remapIdsForPaste
- features/net/net-ops.js: deleteNodesAndIncidentArcs, copySelection, pasteClipboard (ID remap, offset)
- utils/z3/eval-bool.js: parser precedence & nesting (and/&&, or/||, xor/^, implies/->, iff/<->), invalid input
- utils/z3/eval-arith.js: evaluateArithmeticWithBindings for concat/substring/length/head/tail/append/sublist on ground terms; error cases

(Leverage existing unit tests for history manager, ADT parsers, core components; avoid duplication.)

## 3) Component Tests (targeted additions)

- PetriNetPanel.jsx: algebraic vs PT markings formatting; enabled transitions render; testids
- EnabledTransitionsPanel.jsx: onFire callback; non-button close control not counted among buttons
- Place.jsx / Transition.jsx: drag start/move/end updates via mocked context setters; snapIndicator toggling

## 4) E2E Playwright: Harden and Extend

- editor.spec.js: assert counts after create/delete; verify grid-snap toggle state
- element-selection.spec.js: rectangle selection count; topology preserved; copy→paste→delete with exact counts and retries
- simulation.spec.js: click-to-fire enabled transitions updates markings (stabilize waits/selectors); keep equations out pending Z3
- ADT-evaluation.spec.js: keep boolean and term reductions; add skip guard for equation tests when Z3 served later

## 5) Coverage Targets & CI Gates

- Jest thresholds (after additions): lines ≥ 85%, branches ≥ 75%, functions ≥ 85%
- Playwright: run core suites on CI per PR
- Enforce thresholds in jest.config.cjs

## 6) Stability & Infra

- Audit/extend data-testid usage across interactive elements
- Provide helper to click by virtual canvas coordinates
- Centralize waits/retries for async UI updates in Playwright helpers

## 7) Documentation

- Update docs/developer-guide.md with testing workflow, coverage viewing, and testid guidance

## 8) Work Items (delta only)

- Unit: ~10–12 new spec files (utils/selection/net-ops/z3 eval)
- Component: 3–4 focused specs
- E2E: 3–4 enhancements/hardening passes

## 9) Sequencing

1. Add missing testids (minimal, no behavior change)
2. Unit tests for utils/selection/net-ops
3. Component tests (PetriNetPanel, EnabledTransitionsPanel, Place/Transition behaviors)
4. E2E hardening (editor, selection, simulation) and ADT boolean/term stability
5. E2E suite reorg/renaming and helper centralization
6. Add coverage gates & CI integration

### To-dos

- [ ] Add token-format utils and switch PropertiesPanel and PetriNetPanel to use them
- [ ] Add net selectors and adopt in panels
- [ ] Extract selection and multi-drag pure helpers and wire sites
- [ ] Extract clipboard helpers and integrate copy/paste
- [ ] Add delete/copy/paste net-ops helpers and wire keyboard shortcuts
- [ ] Allow injecting simCore into useSimulationManager for future tests
- [ ] Ensure stable context exports; verify dev HMR warnings gone