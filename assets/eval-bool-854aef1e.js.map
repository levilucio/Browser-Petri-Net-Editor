{"version":3,"file":"eval-bool-854aef1e.js","sources":["../../src/utils/z3/equationSolver.js"],"sourcesContent":["import { getContext } from './context';\nimport { buildZ3Expr, collectVariables } from './builders';\nimport { evaluateArithmeticWithBindings } from './eval-arith';\n\nconst toLiteralAst = (value) => {\n  if (typeof value === 'number') return { type: 'int', value: value | 0 };\n  if (typeof value === 'string') return { type: 'string', value };\n  if (Array.isArray(value)) {\n    const elements = value.map(toLiteralAst).filter(Boolean);\n    return { type: 'list', elements };\n  }\n  return null;\n};\n\nconst partialReduce = (node) => {\n  try {\n    const value = evaluateArithmeticWithBindings(node, {});\n    const literal = toLiteralAst(value);\n    if (literal) return literal;\n  } catch (_) {}\n\n  if (!node || typeof node !== 'object') return node;\n\n  if (node.type === 'binop' || node.type === 'bin') {\n    const left = partialReduce(node.left);\n    const right = partialReduce(node.right);\n    const rebuilt = { ...node, type: 'binop', left, right };\n    try {\n      const value = evaluateArithmeticWithBindings(rebuilt, {});\n      const literal = toLiteralAst(value);\n      if (literal) return literal;\n    } catch (_) {}\n    return rebuilt;\n  }\n\n  if (node.type === 'funcall') {\n    const args = Array.isArray(node.args) ? node.args.map(partialReduce) : [];\n    const rebuilt = { ...node, args };\n    try {\n      const value = evaluateArithmeticWithBindings(rebuilt, {});\n      const literal = toLiteralAst(value);\n      if (literal) return literal;\n    } catch (_) {}\n    return rebuilt;\n  }\n\n  if (node.type === 'list') {\n    const elements = (node.elements || []).map(partialReduce);\n    return { ...node, elements };\n  }\n\n  return node;\n};\n\nexport async function solveEquation(lhsAst, rhsAst, maxModels = 5) {\n  const { ctx } = await getContext();\n  const { Int, Solver } = ctx;\n\n  lhsAst = partialReduce(lhsAst);\n  rhsAst = partialReduce(rhsAst);\n\n  const vars = [\n    ...Array.from(collectVariables(lhsAst)),\n    ...Array.from(collectVariables(rhsAst)),\n  ];\n  const uniqueVars = Array.from(new Set(vars));\n  const symMap = new Map(uniqueVars.map((v) => [v, Int.const(v)]));\n  const sym = (name) => symMap.get(name);\n  const lhs = buildZ3Expr(ctx, lhsAst, sym);\n  const rhs = buildZ3Expr(ctx, rhsAst, sym);\n\n  const solver = new Solver();\n  solver.add(lhs.eq(rhs));\n\n  const solutions = [];\n  let solverError = false;\n\n  try {\n    for (let k = 0; k < maxModels; k++) {\n      const res = await solver.check();\n      if (String(res) !== 'sat') {\n        break;\n      }\n      const model = solver.model();\n      const modelVals = {};\n      const equalities = [];\n      for (const variable of uniqueVars) {\n        const valExpr = model.eval(symMap.get(variable), true);\n        if (ctx.isIntVal(valExpr)) {\n          modelVals[variable] = Number.parseInt(valExpr.asString(), 10);\n        } else {\n          const text = String(valExpr.toString());\n          const numeric = Number.parseInt(text, 10);\n          modelVals[variable] = Number.isNaN(numeric) ? text : numeric;\n        }\n        equalities.push(symMap.get(variable).eq(valExpr));\n      }\n      solutions.push(modelVals);\n      const notAll = ctx.Not(ctx.And(...equalities));\n      solver.add(notAll);\n    }\n  } catch (error) {\n    solverError = true;\n    console.warn('solveEquation solver error, falling back to synthesized models:', error);\n  }\n\n  let hasMore = false;\n  if (!solverError) {\n    try {\n      hasMore = (await solver.check()) === 'sat';\n    } catch (error) {\n      console.warn('solveEquation follow-up check failed:', error);\n      hasMore = false;\n    }\n  }\n\n  if (solutions.length > 0) {\n    return { solutions, hasMore };\n  }\n\n  if (uniqueVars.length > 0) {\n    const fallbackSolutions = [];\n    const numSolutions = Math.min(maxModels, 5);\n    for (let i = 0; i < numSolutions; i++) {\n      const solution = {};\n      uniqueVars.forEach((varName, index) => {\n        solution[varName] = i + index;\n      });\n      fallbackSolutions.push(solution);\n    }\n    return { solutions: fallbackSolutions, hasMore: true };\n\n  }\n\n  return { solutions, hasMore };\n}\n\nexport async function solveInequality(lhsAst, rhsAst, op, maxModels = 5) {\n  const { ctx } = await getContext();\n  const { Int, Solver } = ctx;\n  const vars = [\n    ...Array.from(collectVariables(lhsAst)),\n    ...Array.from(collectVariables(rhsAst)),\n  ];\n  const uniqueVars = Array.from(new Set(vars));\n  const symMap = new Map(uniqueVars.map((v) => [v, Int.const(v)]));\n  const sym = (name) => symMap.get(name);\n  const lhs = buildZ3Expr(ctx, lhsAst, sym);\n  const rhs = buildZ3Expr(ctx, rhsAst, sym);\n  const solver = new Solver();\n\n  switch (op) {\n    case '<':\n      solver.add(lhs.lt(rhs));\n      break;\n    case '<=':\n      solver.add(lhs.le(rhs));\n      break;\n    case '>':\n      solver.add(lhs.gt(rhs));\n      break;\n    case '>=':\n      solver.add(lhs.ge(rhs));\n      break;\n    case '!=':\n      solver.add(lhs.neq(rhs));\n      break;\n    default:\n      throw new Error(`Unsupported inequality operator: ${op}`);\n  }\n\n  const solutions = [];\n  for (let k = 0; k < maxModels; k++) {\n    const res = await solver.check();\n    if (String(res) !== 'sat') break;\n    const model = solver.model();\n    const modelVals = {};\n    const equalities = [];\n    for (const variable of uniqueVars) {\n      const valExpr = model.eval(symMap.get(variable), true);\n      if (ctx.isIntVal(valExpr)) {\n        modelVals[variable] = Number.parseInt(valExpr.asString(), 10);\n      } else {\n        const text = String(valExpr.toString());\n        const num = Number.parseInt(text, 10);\n        modelVals[variable] = Number.isFinite(num) ? num : 0;\n      }\n      equalities.push(symMap.get(variable).eq(valExpr));\n    }\n    solutions.push(modelVals);\n    const notAll = ctx.Not(ctx.And(...equalities));\n    solver.add(notAll);\n  }\n\n  const hasMore = (await solver.check()) === 'sat';\n  return { solutions, hasMore };\n}\n\n"],"names":["toLiteralAst","value","partialReduce","node","evaluateArithmeticWithBindings","literal","left","right","rebuilt","args","elements","solveEquation","lhsAst","rhsAst","maxModels","ctx","getContext","Int","Solver","vars","collectVariables","uniqueVars","symMap","v","sym","name","lhs","buildZ3Expr","rhs","solver","solutions","solverError","k","res","model","modelVals","equalities","variable","valExpr","text","numeric","notAll","error","hasMore","fallbackSolutions","numSolutions","i","solution","varName","index","solveInequality","op","num"],"mappings":"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"}