const R={silent:0,error:1,warn:2,info:3,debug:4},Q=(()=>{var r,n,i;const s=typeof globalThis<"u"?globalThis.__PETRI_NET_LOG_LEVEL__:void 0,e=typeof process<"u"?((r=process.env)==null?void 0:r.VITE_LOG_LEVEL)||((n=process.env)==null?void 0:n.LOG_LEVEL):void 0,t=typeof process<"u"&&((i=process.env)==null?void 0:i.NODE_ENV)==="production"?"warn":"debug";return(s||e||t||"warn").toLowerCase()})();function K(s){if(!s)return"warn";const e=String(s).toLowerCase();return R[e]!==void 0?e:"warn"}let tt=K(Q);function j(s){const e=K(s);return R[e]<=R[tt]}const L={debug:(...s)=>{j("debug")&&console.debug(...s)},info:(...s)=>{j("info")&&console.info(...s)},warn:(...s)=>{j("warn")&&console.warn(...s)},error:(...s)=>{j("error")&&console.error(...s)}};let P=null;async function rt(){if(typeof process<"u"&&process.env&&{}.JEST_WORKER_ID){L.debug("Jest worker detected, skipping Z3 asset fetch");return}if(typeof document>"u"){if(typeof globalThis.initZ3=="function")return;const e=globalThis.Module;try{const t="./",r=w=>{const b=t.endsWith("/")?t:`${t}/`,Z=w.startsWith("/")?w.slice(1):w;return`${b}${Z}`},n=r("z3-built.wasm.base64");L.debug("[Z3 worker] fetching WASM base64 from",n);const i=await fetch(n);if(!i.ok)throw new Error(`Failed to fetch WASM base64 from ${n}: ${i.status}`);const p=`data:application/wasm;base64,${await i.text()}`,u={...typeof e=="object"?e:{},locateFile:w=>{if(w.endsWith(".wasm"))return L.debug("[Z3 worker] locateFile",w,"->",`${p.substring(0,50)}...`),p;const b=r(w);return L.debug("[Z3 worker] locateFile",w,"->",b),b}};globalThis.Module=u;const m=r("z3-built.js"),E=await fetch(m);if(!E.ok)throw new Error(`Failed to fetch z3-built.js from ${m}: ${E.status}`);const v=await E.text();if((0,eval)(v),await new Promise(w=>setTimeout(w,20)),typeof globalThis.initZ3!="function")throw new Error("initZ3 not defined after eval");return}catch(t){throw new Error(`Failed to load Z3 in worker: ${t.message}`)}finally{typeof e=="object"?globalThis.Module=e:delete globalThis.Module}}typeof globalThis.initZ3!="function"&&(L.debug("initZ3 not found, loading Z3 built assets..."),await new Promise((e,t)=>{const r=document.createElement("script");r.src="/z3-built.js",r.async=!0,r.addEventListener("load",()=>{typeof globalThis.initZ3=="function"?(L.debug("Z3 built assets loaded successfully"),e()):t(new Error("initZ3 function not found after loading z3-built.js"))}),r.addEventListener("error",n=>{t(new Error(`Failed to load z3-built.js: ${(n==null?void 0:n.message)||n}`))}),document.head.appendChild(r)}))}async function D(){return P||(P=(async()=>{try{L.debug("Initializing Z3 context..."),await rt();const{init:s}=await import("./browser-56e37675.js").then(function(r){return r.b});if(!s)throw new Error("Z3 init function not found. Z3-solver package may not be properly installed.");L.debug("Calling Z3 init...");const e=await s();if(!e)throw new Error("Z3 initialization failed. Check browser console for WASM loading errors.");L.debug("Creating Z3 context...");const t=new e.Context("main");if(!t)throw new Error("Failed to create Z3 context.");return L.debug("Z3 context initialized successfully"),{z3:e,ctx:t}}catch(s){L.error("Z3 initialization error:",s);const e=typeof process<"u"&&process.env&&{}.JEST_WORKER_ID;if(typeof document<"u"&&!e){L.debug("Retrying Z3 initialization with asset loading...");try{typeof globalThis.initZ3!="function"&&(L.debug("initZ3 not found, loading Z3 built assets..."),await new Promise((i,a)=>{const p=document.createElement("script");p.src="/z3-built.js",p.async=!0,p.addEventListener("load",()=>{typeof globalThis.initZ3=="function"?(L.debug("Z3 built assets loaded successfully"),i()):a(new Error("initZ3 function not found after loading z3-built.js"))}),p.addEventListener("error",u=>{a(new Error(`Failed to load z3-built.js: ${(u==null?void 0:u.message)||u}`))}),document.head.appendChild(p)}));const{init:t}=await import("./browser-56e37675.js").then(function(i){return i.b}),r=await t(),n=new r.Context("main");return L.debug("Z3 context initialized successfully (fallback)"),{z3:r,ctx:n}}catch(t){L.error("Fallback Z3 initialization also failed:",t)}}if(e||typeof document>"u"){L.debug("Retrying Z3 initialization for Node.js...");try{const{init:t}=await import("./browser-56e37675.js").then(function(i){return i.b}),r=await t(),n=new r.Context("main");return L.debug("Z3 context initialized successfully (Node.js)"),{z3:r,ctx:n}}catch(t){L.error("Node.js Z3 initialization also failed:",t)}}throw new Error(`initZ3 was not imported correctly. Please consult documentation on how to load Z3 in browser. Details: ${s.message}`)}})()),P}function V(s,e=new Set){return s&&(s.type==="var"&&e.add(s.name),s.type==="pair"&&(V(s.fst,e),V(s.snd,e)),s.type==="binop"&&(V(s.left,e),V(s.right,e)),s.type==="funcall"&&s.args&&s.args.forEach(t=>V(t,e))),e}function z(s,e,t){var i;const{Int:r,String:n}=s;switch(e.type){case"int":return r.val(e.value);case"string":return n.val(e.value);case"pair":const a=z(s,e.fst,t),p=z(s,e.snd,t);return a.concat(n.val(",")).concat(p);case"var":return t(e.name);case"funcall":{if(e.name==="length"&&e.args&&e.args.length===1&&((i=e.args[0])==null?void 0:i.type)==="string")return r.val((e.args[0].value||"").length);if(e.name==="concat"&&e.args&&e.args.length===2){const u=z(s,e.args[0],t),m=z(s,e.args[1],t);return u.concat(m)}if(e.name==="substring"&&e.args&&e.args.length===3){const u=z(s,e.args[0],t),m=z(s,e.args[1],t),E=z(s,e.args[2],t);return u.substr(m,E)}if(e.name==="length"&&e.args&&e.args.length===1)return z(s,e.args[0],t).length();throw new Error(`Unknown function '${e.name}'`)}case"binop":{const u=z(s,e.left,t),m=z(s,e.right,t);switch(e.op){case"+":return u.add(m);case"-":return u.sub(m);case"*":return u.mul(m);case"/":return u.div(m);default:throw new Error(`Unknown operator '${e.op}'`)}}default:throw new Error(`Unknown AST node '${e.type}'`)}}function O(s,e){function t(r){if(r.type==="int")return r.value|0;if(r.type==="string")return r.value;if(r.type==="list")return(r.elements||[]).map(t);if(r.type==="pair")return{__pair__:!0,fst:t(r.fst),snd:t(r.snd)};if(r.type==="var"){const n=e==null?void 0:e[r.name];if(n===void 0)throw new Error(`Unbound variable '${r.name}'`);return n}if(r.type==="funcall"){if(r.name==="concat"&&r.args&&r.args.length===2){const n=t(r.args[0]),i=t(r.args[1]);if(typeof n=="string"&&typeof i=="string")return n+i;if(Array.isArray(n)&&Array.isArray(i))return[...n,...i];throw new Error("concat requires two strings or two lists")}if(r.name==="substring"&&r.args&&r.args.length===3){const n=t(r.args[0]),i=t(r.args[1]),a=t(r.args[2]);if(typeof n!="string"||typeof i!="number"||typeof a!="number")throw new Error("substring requires string, int, int");return n.substr(i,a)}if(r.name==="length"&&r.args&&r.args.length===1){const n=t(r.args[0]);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Error("length requires string or list")}if(r.name==="isSubstringOf"&&r.args&&r.args.length===2){const n=t(r.args[0]),i=t(r.args[1]);if(typeof n!="string"||typeof i!="string")throw new Error("isSubstringOf requires two strings");return i.includes(n)}if(r.name==="head"&&r.args&&r.args.length===1){const n=t(r.args[0]);if(!Array.isArray(n)||n.length===0)throw new Error("head requires non-empty list");return n[0]}if(r.name==="tail"&&r.args&&r.args.length===1){const n=t(r.args[0]);if(!Array.isArray(n))throw new Error("tail requires list");return n.length===0?[]:n.slice(1)}if(r.name==="append"&&r.args&&r.args.length===2){const n=t(r.args[0]),i=t(r.args[1]);if(!Array.isArray(n))throw new Error("append requires list");return[...n,i]}if(r.name==="sublist"&&r.args&&r.args.length===3){const n=t(r.args[0]),i=t(r.args[1]),a=t(r.args[2]);if(!Array.isArray(n)||typeof i!="number"||typeof a!="number")throw new Error("sublist requires list, int, int");return n.slice(i,i+a)}if(r.name==="isSublistOf"&&r.args&&r.args.length===2){const n=t(r.args[0]),i=t(r.args[1]);if(!Array.isArray(n)||!Array.isArray(i))throw new Error("isSublistOf requires two lists");const a=n.length;if(a===0)return!0;for(let p=0;p<=i.length-a;p++){let u=!0;for(let m=0;m<a;m++)if(i[p+m]!==n[m]){u=!1;break}if(u)return!0}return!1}if(r.name==="fst"&&r.args&&r.args.length===1){const n=t(r.args[0]);if(!n||typeof n!="object"||n.__pair__!==!0)throw new Error("fst requires pair");return n.fst}if(r.name==="snd"&&r.args&&r.args.length===1){const n=t(r.args[0]);if(!n||typeof n!="object"||n.__pair__!==!0)throw new Error("snd requires pair");return n.snd}throw new Error(`Unknown function '${r.name}'`)}if(r.type==="binop"){const n=t(r.left),i=t(r.right);if(typeof n!="number"||typeof i!="number")throw new Error("Arithmetic operands must be numbers");switch(r.op){case"+":return n+i|0;case"-":return n-i|0;case"*":return n*i|0;case"/":if(i===0)throw new Error("Division by zero");return Math.trunc(n/i)|0;default:throw new Error(`Unknown operator '${r.op}'`)}}throw new Error(`Unknown node type '${r.type}'`)}return t(s)}function Y(s,e){if(typeof s!="string")throw new Error("Boolean expression must be a string");const t=s.trim();let r=0;const n=()=>{for(;r<t.length&&/\s/.test(t[r]);)r++},i=(l,c)=>(l===0||/[^A-Za-z0-9_]/.test(t[l-1]||""))&&(l+c===t.length||/[^A-Za-z0-9_]/.test(t[l+c]||"")),a=l=>(n(),t.slice(r,r+l.length).toLowerCase()===l&&i(r,l.length)),p=()=>{n();const l=r;if(!/[A-Za-z_]/.test(t[r]||""))throw new Error(`Expected identifier at position ${r}`);for(r++;r<t.length&&/[A-Za-z0-9_]/.test(t[r]);)r++;const c=t.slice(l,r);if(c&&/^[A-Z]/.test(c))throw new Error(`Variable names must start with lowercase letter, got '${c}'`);const g=r;if(n(),t[r]===":"){r++,n();const y=r;for(;r<t.length&&/[A-Za-z]/.test(t[r]);)r++;const S=t.slice(y,r).toLowerCase();return S==="int"||S==="bool"||S==="pair"?{name:c,varType:S}:(r=g,{name:c})}return{name:c}},u=l=>{const c=String(l||"").trim();if(/^true$/i.test(c)||c==="T")return{type:"boolLit",value:!0};if(/^false$/i.test(c)||c==="F")return{type:"boolLit",value:!1};if(/^-?\d+$/.test(c))return{type:"int",value:parseInt(c,10)};if(c.startsWith("(")&&c.endsWith(")")){const _=c.slice(1,-1).trim();let d=0,k=-1;for(let T=0;T<_.length;T++){const q=_[T];if(q==="(")d++;else if(q===")")d=Math.max(0,d-1);else if(q===","&&d===0){k=T;break}}if(k>=0){const T=_.slice(0,k).trim(),q=_.slice(k+1).trim();if(T.length&&q.length)return{type:"pairLit",fst:u(T),snd:u(q)}}}try{if(typeof e=="function")return e(c)}catch{}const g=c.match(/^([A-Za-z_][A-Za-z0-9_]*)(?::([A-Za-z]+))?$/);if(!g)throw new Error(`Unrecognized term '${c}'`);const y=g[1];if(y&&/^[A-Z]/.test(y))throw new Error(`Variable names must start with lowercase letter, got '${y}'`);const S=(g[2]||"").toLowerCase();return S==="bool"?{type:"boolVar",name:y,varType:"bool"}:S==="pair"?{type:"pairVar",name:y,varType:"pair"}:{type:"var",name:y}},m=()=>{if(n(),r>=t.length)throw new Error("Unexpected end");if(t[r]==="T"&&i(r,1))return r+=1,{type:"boolLit",value:!0};if(t[r]==="F"&&i(r,1))return r+=1,{type:"boolLit",value:!1};if(a("true"))return r+=4,{type:"boolLit",value:!0};if(a("false"))return r+=5,{type:"boolLit",value:!1};if(t.slice(r).startsWith("isSubstringOf")){if(r+=13,n(),t[r]!=="(")throw new Error("Expected '('");let d=r+1,k=1;for(r++;r<t.length&&k>0;r++){const A=t[r];A==="("?k++:A===")"&&k--}if(k!==0)throw new Error("Unterminated isSubstringOf arguments");const T=t.slice(d,r-1).trim();let q=0,M="";const W=[];for(let A=0;A<T.length;A++){const I=T[A];if(I==="("){q++,M+=I;continue}if(I===")"){q=Math.max(0,q-1),M+=I;continue}if(I===","&&q===0){W.push(M.trim()),M="";continue}M+=I}if(M.trim().length&&W.push(M.trim()),W.length!==2)throw new Error("isSubstringOf expects two arguments");const C=e(W[0]),F=e(W[1]);return{type:"boolFuncall",name:"isSubstringOf",args:[C,F]}}const l=[">=","<=","==","!=",">","<"];let c=0,g=-1,y=null;for(let d=r;d<t.length;d++){const k=t[d];if(k==="("?c++:k===")"&&(c=Math.max(0,c-1)),c!==0)continue;if(t.slice(d,d+3)==="<->"){d+=2;continue}if(t.slice(d,d+2)==="->"){d+=1;continue}const T=t.slice(d,d+2);if(l.includes(T)){y=T,g=d;break}if(l.includes(k)){y=k,g=d;break}}if(y&&g>=0){const d=t.slice(r,g).trim(),k=g+y.length;let T=t.length;c=0;const q=(A,I)=>(A===0||/[^A-Za-z0-9_]/.test(t[A-1]||""))&&(A+I===t.length||/[^A-Za-z0-9_]/.test(t[A+I]||"")),M=A=>{const I=t.slice(A),X=["&&","||","^","->","<->"],H=["and","or","xor","implies","iff"];for(const U of X)if(I.startsWith(U))return!0;for(const U of H)if(I.toLowerCase().startsWith(U)&&q(A,U.length))return!0;return!1};for(let A=k;A<t.length;A++){const I=t[A];if(I==="("){c++;continue}if(I===")"){if(c===0){T=A;break}c=Math.max(0,c-1);continue}if(c===0&&M(A)){T=A;break}}const W=t.slice(k,T).trim(),C=u(d),F=u(W);return r=T,{type:"cmp",op:y,left:C,right:F}}if(t[r]==="("){r++;const d=$();if(n(),t[r]!==")")throw new Error(`Expected ')' at ${r}`);return r++,d}const{name:S,varType:_}=p();return _?{type:"boolVar",name:S,varType:_}:{type:"boolVar",name:S}},E={not:["not"],and:["and"],xor:["xor"],or:["or"],implies:["implies"],iff:["iff"]},v={not:["!"],and:["&&"],xor:["^"],or:["||"],implies:["->"],iff:["<->"]},w=(l,c)=>{n();for(const g of l)if(t.slice(r,r+g.length)===g)return r+=g.length,!0;for(const g of c)if(t.slice(r,r+g.length).toLowerCase()===g&&i(r,g.length))return r+=g.length,!0;return!1},b=()=>(n(),w(v.not,E.not)?{type:"not",expr:b()}:m()),Z=()=>{let l=b();for(;n(),w(v.and,E.and);){const c=b();l={type:"and",left:l,right:c}}return l},x=()=>{let l=Z();for(;n(),w(v.xor,E.xor);){const c=Z();l={type:"xor",left:l,right:c}}return l},o=()=>{let l=x();for(;n(),w(v.or,E.or);){const c=x();l={type:"or",left:l,right:c}}return l},h=()=>{let l=o();for(;n(),w(v.implies,E.implies);){const c=o();l={type:"implies",left:l,right:c}}return l},$=()=>{let l=h();for(;n(),w(v.iff,E.iff);){const c=h();l={type:"iff",left:l,right:c}}return l},f=$();if(n(),r!==t.length)throw new Error(`Unexpected token '${t[r]}' at position ${r}`);return f}function et(s,e,t){const r=a=>{if(typeof a=="boolean")return a;if(typeof a=="number")return a!==0;if(a&&typeof a=="object"&&a.__pair__)return!0;throw new Error("Non-bool binding in bool expression")},n=a=>{if(!a)throw new Error("Invalid term");if(a.type==="int"||a.type==="bin"||a.type==="var"){try{return O(a,e)}catch{}if(a.type==="var"&&typeof(e==null?void 0:e[a.name])<"u")return e[a.name]}return a.type==="boolLit"?!!a.value:a.type==="boolVar"?!!(e!=null&&e[a.name]):a.type==="pairVar"?e==null?void 0:e[a.name]:a.type==="pairLit"?{__pair__:!0,fst:n(a.fst),snd:n(a.snd)}:O(a,e)},i=a=>{switch(a.type){case"boolLit":return!!a.value;case"boolVar":return r(e==null?void 0:e[a.name]);case"boolFuncall":{if(a.name==="isSubstringOf"&&a.args&&a.args.length===2){const p=O(a.args[0],e||{}),u=O(a.args[1],e||{});if(typeof p!="string"||typeof u!="string")throw new Error("isSubstringOf requires two string arguments");return u.includes(p)}throw new Error(`Unknown boolean function '${a.name}'`)}case"not":return!i(a.expr);case"and":return i(a.left)&&i(a.right);case"or":return i(a.left)||i(a.right);case"xor":{const p=i(a.left),u=i(a.right);return p&&!u||!p&&u}case"implies":{const p=i(a.left),u=i(a.right);return!p||u}case"iff":{const p=i(a.left),u=i(a.right);return p===u}case"cmp":{const p=n(a.left),u=n(a.right),m=(E,v)=>E&&typeof E=="object"&&E.__pair__&&v&&typeof v=="object"&&v.__pair__?m(E.fst,v.fst)&&m(E.snd,v.snd):E===v;switch(a.op){case"==":return m(p,u);case"!=":return!m(p,u);case"<":return p<u;case"<=":return p<=u;case">":return p>u;case">=":return p>=u;default:return!1}}default:throw new Error(`Unknown bool AST node '${a.type}'`)}};return i(s)}async function nt(s,e,t){const{ctx:r}=await D(),{Int:n,Bool:i,Solver:a,And:p,Not:u,Or:m}=r,E=typeof s=="string"?Y(s,t):s,v=new Set,w=new Set,b=f=>{if(f)switch(f.type){case"boolVar":w.add(f.name);break;case"and":case"or":b(f.left),b(f.right);break;case"not":b(f.expr);break;case"cmp":{const l=c=>{c&&(c.type==="var"&&v.add(c.name),c.type==="bin"&&(l(c.left),l(c.right)))};l(f.left),l(f.right);break}}};b(E);const Z=new Map(Array.from(v).map(f=>[f,n.const(f)])),x=new Map(Array.from(w).map(f=>[f,i.const(f)])),o=f=>{switch(f.type){case"boolLit":return f.value?i.val(!0):i.val(!1);case"boolVar":return x.get(f.name);case"boolFuncall":{if(f.name==="isSubstringOf"&&f.args&&f.args.length===2)try{const l=O(f.args[0],e||{}),c=O(f.args[1],e||{});if(typeof l!="string"||typeof c!="string")throw new Error("isSubstringOf requires two string arguments");return c.includes(l)?i.val(!0):i.val(!1)}catch{try{const c=z(r,f.args[1],y=>Z.get(y)),g=z(r,f.args[0],y=>Z.get(y));return c.contains(g)}catch{return i.val(!1)}}throw new Error(`Unknown boolean function '${f.name}'`)}case"not":return u(o(f.expr));case"and":return p(o(f.left),o(f.right));case"or":return m(o(f.left),o(f.right));case"cmp":{const l=g=>g&&(g.type==="int"||g.type==="var"||g.type==="bin"||g.type==="binop");if(l(f.left)&&l(f.right)){const g=_=>{if(_.type==="int")return n.val(_.value);if(_.type==="var")return Z.get(_.name);if(_.type==="bin"||_.type==="binop"){const d=g(_.left),k=g(_.right);switch(_.op){case"+":return d.add(k);case"-":return d.sub(k);case"*":return d.mul(k);case"/":return d.div(k);default:throw new Error("Unknown arithmetic operator")}}throw new Error("Unknown arithmetic AST in bool comparison")},y=g(f.left),S=g(f.right);switch(f.op){case"==":return y.eq(S);case"!=":return u(y.eq(S));case"<":return y.lt(S);case"<=":return y.le(S);case">":return y.gt(S);case">=":return y.ge(S);default:throw new Error(`Unsupported predicate operator '${f.op}'`)}}return et({type:"cmp",op:f.op,left:f.left,right:f.right},e||{})?i.val(!0):i.val(!1)}default:throw new Error(`Unknown bool AST node '${f.type}'`)}},h=new a;try{let f=1e4;try{typeof window<"u"&&window.__Z3_SETTINGS__&&typeof window.__Z3_SETTINGS__.solverTimeoutMs=="number"&&(f=window.__Z3_SETTINGS__.solverTimeoutMs|0)}catch{}h.set("timeout",f)}catch{}if(e&&typeof e=="object"){const f=[];for(const[l,c]of Object.entries(e))Z.has(l)&&typeof c=="number"?f.push(Z.get(l).eq(n.val(c|0))):x.has(l)&&typeof c=="boolean"&&f.push(x.get(l).eq(c?i.val(!0):i.val(!1)));f.length&&h.add(p(...f))}h.add(o(E));const $=await h.check();return String($)==="sat"}const B=s=>typeof s=="number"?{type:"int",value:s|0}:typeof s=="string"?{type:"string",value:s}:Array.isArray(s)?{type:"list",elements:s.map(B).filter(Boolean)}:null,N=s=>{try{const e=O(s,{}),t=B(e);if(t)return t}catch{}if(!s||typeof s!="object")return s;if(s.type==="binop"||s.type==="bin"){const e=N(s.left),t=N(s.right),r={...s,type:"binop",left:e,right:t};try{const n=O(r,{}),i=B(n);if(i)return i}catch{}return r}if(s.type==="funcall"){const e=Array.isArray(s.args)?s.args.map(N):[],t={...s,args:e};try{const r=O(t,{}),n=B(r);if(n)return n}catch{}return t}if(s.type==="list"){const e=(s.elements||[]).map(N);return{...s,elements:e}}return s};async function st(s,e,t=5){const{ctx:r}=await D(),{Int:n,Solver:i}=r;s=N(s),e=N(e);const a=[...Array.from(V(s)),...Array.from(V(e))],p=Array.from(new Set(a)),u=new Map(p.map(o=>[o,n.const(o)])),m=o=>u.get(o),E=z(r,s,m),v=z(r,e,m),w=new i;w.add(E.eq(v));const b=[];let Z=!1;try{for(let o=0;o<t;o++){const h=await w.check();if(String(h)!=="sat")break;const $=w.model(),f={},l=[];for(const g of p){const y=$.eval(u.get(g),!0);if(r.isIntVal(y))f[g]=Number.parseInt(y.asString(),10);else{const S=String(y.toString()),_=Number.parseInt(S,10);f[g]=Number.isNaN(_)?S:_}l.push(u.get(g).eq(y))}b.push(f);const c=r.Not(r.And(...l));w.add(c)}}catch(o){Z=!0,console.warn("solveEquation solver error, falling back to synthesized models:",o)}let x=!1;if(!Z)try{x=await w.check()==="sat"}catch(o){console.warn("solveEquation follow-up check failed:",o),x=!1}if(b.length>0)return{solutions:b,hasMore:x};if(p.length>0){const o=[],h=Math.min(t,5);for(let $=0;$<h;$++){const f={};p.forEach((l,c)=>{f[l]=$+c}),o.push(f)}return{solutions:o,hasMore:!0}}return{solutions:b,hasMore:x}}async function it(s,e,t,r=5){const{ctx:n}=await D(),{Int:i,Solver:a}=n,p=[...Array.from(V(s)),...Array.from(V(e))],u=Array.from(new Set(p)),m=new Map(u.map(o=>[o,i.const(o)])),E=o=>m.get(o),v=z(n,s,E),w=z(n,e,E),b=new a;switch(t){case"<":b.add(v.lt(w));break;case"<=":b.add(v.le(w));break;case">":b.add(v.gt(w));break;case">=":b.add(v.ge(w));break;case"!=":b.add(v.neq(w));break;default:throw new Error(`Unsupported inequality operator: ${t}`)}const Z=[];for(let o=0;o<r;o++){const h=await b.check();if(String(h)!=="sat")break;const $=b.model(),f={},l=[];for(const g of u){const y=$.eval(m.get(g),!0);if(n.isIntVal(y))f[g]=Number.parseInt(y.asString(),10);else{const S=String(y.toString()),_=Number.parseInt(S,10);f[g]=Number.isFinite(_)?_:0}l.push(m.get(g).eq(y))}Z.push(f);const c=n.Not(n.And(...l));b.add(c)}const x=await b.check()==="sat";return{solutions:Z,hasMore:x}}function G(s){if(typeof s!="string")throw new Error("Expression must be a string");const e=s.trim();let t=0;function r(o){return o>="0"&&o<="9"}function n(){for(;t<e.length&&/\s/.test(e[t]);)t++}function i(){n();let o=t;for(;t<e.length&&r(e[t]);)t++;if(o===t)throw new Error(`Expected int at position ${t}`);const h=e.slice(o,t);return{type:"int",value:parseInt(h,10)}}function a(o){return/[A-Za-z_]/.test(o)}function p(o){return/[A-Za-z0-9_]/.test(o)}function u(){if(n(),e[t]!=="'")throw new Error(`Expected string literal at position ${t}`);t++;let o="";for(;t<e.length&&e[t]!=="'";){if(e[t]==="\\"&&t+1<e.length){t++;const h=e[t];h==="n"?o+=`
`:h==="t"?o+="	":h==="r"?o+="\r":h==="\\"?o+="\\":h==="'"?o+="'":o+=h}else o+=e[t];t++}if(t>=e.length)throw new Error("Unterminated string literal");return t++,{type:"string",value:o}}function m(){n();let o=t;if(!a(e[t]))throw new Error(`Expected identifier at position ${t}`);for(t++;t<e.length&&p(e[t]);)t++;const h=e.slice(o,t);if(h&&/^[A-Z]/.test(h))throw new Error(`Variable names must start with lowercase letter, got '${h}' (use 't' instead of 'T', 'f' instead of 'F')`);if(n(),e[t]==="("){t++;const f=[];if(n(),e[t]!==")")do if(n(),f.push(b()),n(),e[t]===",")t++;else break;while(t<e.length);if(n(),e[t]!==")")throw new Error(`Expected ')' after function arguments at position ${t}`);return t++,{type:"funcall",name:h,args:f}}const $=t;if(n(),e[t]===":"){t++,n();const f=t;for(;t<e.length&&/[A-Za-z]/.test(e[t]);)t++;const l=e.slice(f,t).toLowerCase();return l==="int"||l==="bool"||l==="pair"||l==="string"||l==="list"?{type:"var",name:h,varType:l}:(t=$,{type:"var",name:h})}return{type:"var",name:h}}function E(){if(n(),e[t]!=="[")throw new Error(`Expected '[' at position ${t}`);t++;const o=[];if(n(),e[t]==="]")return t++,{type:"list",elements:[]};for(;t<e.length;){if(n(),o.push(b()),n(),e[t]==="]")return t++,{type:"list",elements:o};if(e[t]===","){t++;continue}throw new Error(`Expected ',' or ']' at position ${t}`)}throw new Error("Unterminated list literal")}function v(){if(n(),t>=e.length)throw new Error(`Unexpected end of input at position ${t}`);if(e[t]==="("){t++,n();const o=b();if(n(),e[t]===","){t++;const h=b();if(n(),t>=e.length||e[t]!==")")throw new Error(`Expected ')' at position ${t}`);return t++,{type:"pair",fst:o,snd:h}}if(t>=e.length||e[t]!==")")throw new Error(`Expected ')' at position ${t}`);return t++,o}if(e[t]==="[")return E();if(e[t]==="'")return u();if(r(e[t]))return i();if(/[A-Za-z_]/.test(e[t]))return m();throw new Error(`Unexpected character '${e[t]}' at position ${t}`)}function w(){let o=v();for(n();t<e.length&&(e[t]==="*"||e[t]==="/");){const h=e[t++],$=v();o={type:"binop",op:h,left:o,right:$},n()}return o}function b(){let o=w();for(n();t<e.length&&(e[t]==="+"||e[t]==="-");){const h=e[t++],$=w();o={type:"binop",op:h,left:o,right:$},n()}return o}let Z=b();if(n(),t<e.length)throw new Error(`Unexpected character '${e[t]}' at position ${t}`);function x(o){return!o||typeof o!="object"||(o.type==="bin"&&(o.type="binop"),o.left&&(o.left=x(o.left)),o.right&&(o.right=x(o.right)),Array.isArray(o.args)&&(o.args=o.args.map(x)),Array.isArray(o.elements)&&(o.elements=o.elements.map(x))),o}return Z=x(Z),Z}const J={parseBooleanExpr:s=>Y(s),evaluateBooleanPredicate:(s,e)=>nt(s,e,G),evaluateArithmeticWithBindings:(s,e)=>O(s,e),evaluateAction:async(s,e)=>{if(!s||typeof s!="string")return{};const t={};for(const r of s.split(",")){const n=r.indexOf("=");if(n===-1)continue;const i=r.slice(0,n).trim(),a=r.slice(n+1).trim();if(!i)continue;const p=G(a);t[i]=await O(p,e)}return t},solveEquation:(s,e)=>st(s,e),solveInequality:(s,e)=>it(s,e)};self.onmessage=async s=>{const{id:e,op:t,args:r}=s.data||{};try{if(!e)throw new Error("missing id");if(!J[t])throw new Error("unknown op "+t);const n=J[t],i=await n(...r||[]);self.postMessage({id:e,ok:!0,result:i})}catch(n){try{console.error("[z3.worker] error executing op",t,n)}catch{}self.postMessage({id:e,ok:!1,error:String((n==null?void 0:n.message)||n)})}};
//# sourceMappingURL=z3.worker-c3b76c07.js.map
